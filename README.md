# About Nextspace

This repo is for the Nextspace frontend. It uses React, Typescript, and [Next.js](https://nextjs.org/). Production is hosted on [Vercel](https://vercel.com/frameworks/nextjs). For more info on the Nextspace backend, check out [LLM Engine](https://github.com/berkmancenter/llm_engine).

## App views overview

### Moderator

This view displays what an event moderator uses when assessing insights and metrics that are being generated by participant questions and feedback. If the event has enabled it and it is provided in the URL as a parameter, a transcript view is also visible. The `ModeratorScreen` function initially attempts to authenticate the user and retrieves an API token, and if successful initializes the socket connection. This socket listens for "message:new" and acts on it as needed.

### Backchannel (participant)

This view displays what an event participant uses to send in questions and feedback during an event. The nomenclature for this channel being utilized is currently a "backchannel". The `BackchannelRoom` function initially attempts to register a new pseudonym for the session and sets local API tokens, if successful. It then joins the socket.io instance and the relevant conversation. The `SendData` utility function is used here to send messages from the user to the API.

## Getting Started

<details>

<summary>Detailed repo structure</summary>

This project uses the Next.js [Pages Router](https://nextjs.org/docs/pages).

- **components/**
  Frontend components used across the app; see [docs/](https://github.com/berkmancenter/nextspace/blob/docs) for a detailed breakdown of each component.

- **docs/**
  Auto-generated static HTML files for code documentation.
- **pages/**
  Next.js pages for the app.

  - **admin/[*type*]/**
    Administration tools; see [dynamic segments](https://nextjs.org/docs/pages/building-your-application/routing/dynamic-routes) in Next.js.
    - **[*id*].tsx**
      Checks the `[id]` and `[type]` and renders an `Event` component.
    - **view/**
      - **[*id*].tsx**
        Checks the `[id]` and renders an `EventStatus` component.
  - **\_app.tsx**
    Custom App file to initialize all pages; see [Next.js docs](https://nextjs.org/docs/pages/building-your-application/routing/custom-app).
  - **\_document.tsx**
    Custom Document used to render pages; see [Next.js docs](https://nextjs.org/docs/pages/building-your-application/routing/custom-document).
  - **moderator.tsx**
    Render the moderator view; see "App views overview".
  - **backchannel.tsx**
    Render the backchannel (participant) view; see "App views overview".

- **utils/**
  Various utilities used across the app; see [docs/](https://github.com/berkmancenter/nextspace/blob/docs) for a detailed breakdown of each method.
  - **Api.ts**
    Helper methods for fetching data from the LLM Engine API.
  - **ErrorHandler.ts**
    Checks if router query parameters are valid.
  - **Helpers.ts**
    General data-handling methods.

</details>

### .env file

Please see the `env.template` to see the needed parameters. Here is a breakdown of what each parameter does.

```
NEXT_PUBLIC_API_URL: the URL you are using to interact with the backend
NEXT_PUBLIC_API_USER: the username that you have registered with the API; see "For first-time setup"
NEXT_PUBLIC_API_PASSWORD: the password of the registered user
NEXT_PUBLIC_SOCKET_URL: the URL to the socket.io instance you are interacting with, e.g. "ws://localhost:5555/?EIO=4&transport=websocket"
NEXT_PUBLIC_DEFAULT_TOPIC_ID: the ID of the default topic that you are submitting new events to; used within the event creation form
NEXT_PUBLIC_ZOOM_URL_PATTERN: optional - Zoom URL regex pattern to match against on event creation form, Defaults to "/https:\/\/[\w-]*\.?zoom.us\/.*/g". Must be string.
NEXT_PUBLIC_ZOOM_DOMAIN: optional - Zoom domain for validation error messages. Defaults to zoom.us.
SESSION_SECRET: crypto key used to encrypt session cookie. Please see key requirements: https://github.com/panva/jose/issues/210#jwe-alg.
```

### Install and run

It is strongly recommended that you utilize [NVM](https://github.com/nvm-sh/nvm) to initiate the version of node recommended by this repo (the minimum version is node [22.0.0](https://nodejs.org/en/blog/release/v22.0.0)):

#### Install NVM

```bash
nvm install
```

#### Install initial dependencies:

```bash
npm install
```

#### Generate a type file:

```bash
npm run openapi-types:generate http://localhost:3000/v1/openapi.json
```

This app uses a types file `types.ts` dynamically generated against the LLM Engine backend server.

The above example generates types against LLM Engine running locally. You can also provide a URL to a remotely hosted LLM Engine instance if you prefer.

#### Run the development server:

```bash
npm run dev
```

#### View the app:

Open [http://localhost:8080](http://localhost:8080) with your browser to see the result.

## Running LLM Engine and NextSpace locally

1. If you would like to run LLM Engine locally, please follow the instructions provided [here](https://github.com/berkmancenter/llm_engine?tab=readme-ov-file#installation) to get setup.
2. Interactions with your local backend API will happen via Postman. Import the latest [collection and environment](https://github.com/berkmancenter/llm_engine/tree/main/postman) for LLM Engine into [Postman](https://www.postman.com/). Use the “localhost-3000…” environment file if you’re locally running LLM Engine.
3. Open Postman and run the following requests:
   1. For first-time setup:
      1. Register “test” user (fill in username, password, email with your own test values)
      2. Login “test” user
      3. In the LLM Engine [localhost](http://localhost) environment, set token to the value of `access.token` in the login response
   2. Create conversation with channels for moderator/participants
      1. In the response body, you should see a passcode for both the moderator and participant channels (see below for more details)
4. Before running nextspace locally, be sure to change the `NEXT_PUBLIC_LLM_FCLTR_TOPIC_ID` in your `.env` file. The conversation ID can be found in the response body created in 3b. You can also find it in the Environment view in Postman under the “Current value” column.
5. When running NextSpace locally, you should now be able to access these channels in your local browser.

> _Note_: A collection of debugging configurations is provided when using VS Code. For help with the debugging in other IDEs or in devtools, see [here](https://nextjs.org/docs/app/guides/debugging).

### URL formatting convention

NextSpace currently uses the following URL convention when loading either the moderator or back channel view:
`.../<moderator|backchannel>?conversationId=<ID>&channel=<channel,password>`

So a full example of this on your local instance might look like

> http://localhost:8080/moderator?conversationId=688a3f0b435a85b2ee2b80cf5&channel=moderator,6ynQWt7W&channel=transcript,uU0MjlX9

This would load the **moderator view** with both the backchannel insights/metrics and transcript.

The conversationId and passcodes can be found in the response body from step 2b. It should look like this:

       "channels": [
               {
                   "_id": "12345678",
                   "name": "moderator",
                   "passcode": "xxxxxx",
                   "__v": 0
               },
               {
                   "_id": "12345678",
                   "name": "participant",
                   "passcode": "xxxxxx",
                   "__v": 0
               }
           ],

The transcript channel password is provided only if you are utilizing one of the API endpoints that includes that as a channel (under "With Transcription" in Postman).

## Deploy your changes to Vercel

This repo automatically has changes deployed to Vercel via the Vercel for GitHub [app](https://github.com/apps/vercel). Changes merged to the `main` branch will be deployed to production, while any feature branch will automatically be deployed to a preview URL. If you have forked this repo and want to deploy changes without usage of this app, you can do so via [the CLI](https://vercel.com/docs/cli).

## License

Nextspace is [AGPL 3.0 licensed](./LICENSE).

## Contributing

This repo will frequently switch contributors and may likely be open sourced down the road. To keep the codebase more easily maintainable by various contributors, we encourage the practices included below.

### Use Conventional Commit Messages

Commit messages can follow the [Conventional Commit Message](https://www.conventionalcommits.org/en/v1.0.0/) pattern of `<type>: <description>`. Types can include any of the examples below.

feat: - A new feature
fix: - A bug fix
chore: - Routine tasks, maintenance, dependencies
docs: - Documentation changes
style: - Code style/formatting changes (not affecting logic)
refactor: - Code changes that neither fix bugs nor add features
test: - Adding or correcting tests
perf: - Performance improvements

It is recommended that you run the command `npm run commit`, which runs hooks to enforce correct commit message format via [husky](https://typicode.github.io/husky/) and [commitlint](https://commitlint.js.org/).
